<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聚会参与投票</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* 新增分享相关样式 */
        .share-section {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .share-btn {
            background: #007AFF;
            margin: 5px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        #qrcode {
            margin: 15px 0;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            display: inline-block;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip-text {
            visibility: hidden;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>匿名投票：旅游管理十周年聚会是否有空参与？</h2>
        <div class="options">
            <label><input type="radio" name="vote" value="有空"> 有空</label><br>
            <label><input type="radio" name="vote" value="没有空"> 没有空</label>
        </div>
        <button onclick="submitVote()">提交投票</button>
        <button onclick="showResults()">查看结果</button>

        <!-- 新增分享区域 -->
        <div class="share-section">
            <h3>分享投票</h3>
            <button class="share-btn" onclick="copyLink()">
                <span class="tooltip">
                    复制链接
                    <span class="tooltip-text">点击复制投票链接</span>
                </span>
            </button>
            <button class="share-btn" onclick="generateQR()">
                <span class="tooltip">
                    生成二维码
                    <span class="tooltip-text">手机扫码分享</span>
                </span>
            </button>
            <div id="qrcode"></div>
            <p id="copyStatus" style="color:green;display:none;">链接已复制到剪贴板！</p>
        </div>

        <canvas id="resultChart"></canvas>
    </div>

    <script>
        // 获取当前页面URL（需部署后生效）
        function getPageURL() {
            // 如果是本地文件，提示需要服务器访问
            if(window.location.protocol === 'file:'){
                return '请将文件上传到服务器后获取有效链接';
            }
            return window.location.href;
        }

        // 复制链接功能
        function copyLink() {
            const url = getPageURL();
            if(url.includes('file:')) {
                alert('请通过本地服务器运行（见下方说明）');
                return;
            }
            
            navigator.clipboard.writeText(url).then(() => {
                document.getElementById('copyStatus').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('copyStatus').style.display = 'none';
                }, 2000);
            }).catch(err => {
                prompt('请手动复制链接：', url);
            });
        }

        // 生成二维码
        let qrGenerated = false;
        function generateQR() {
            if(qrGenerated) return;
            
            const url = getPageURL();
            if(url.includes('file:')) {
                alert('二维码功能需在服务器环境使用');
                return;
            }
            
            new QRCode(document.getElementById("qrcode"), {
                text: url,
                width: 150,
                height: 150,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            qrGenerated = true;
        }

        // 原有投票功能保持不变...
        // （保持之前提交投票和显示结果的代码不变）
    </script>

    <!-- 本地服务器运行说明 -->
    <div style="margin-top:30px; color:#666; font-size:0.9em;">
        <h4>如何多人访问？</h4>
        <p>1. 确保所有设备在同一网络</p>
        <p>2. 终端运行：<code>python3 -m http.server 8000</code></p>
        <p>3. 分享此地址：<span id="localIP">正在获取本机IP...</span></p>
    </div>

    <script>
        // 获取本地IP地址
        async function getLocalIP() {
            try {
                const peer = new RTCPeerConnection();
                peer.createDataChannel('');
                peer.createOffer().then(offer => peer.setLocalDescription(offer));
                
                peer.onicecandidate = e => {
                    if(e.candidate) {
                        const ip = e.candidate.address.match(/(\d+\.){3}\d+/);
                        if(ip) {
                            document.getElementById('localIP').innerHTML = 
                                `http://${ip[0]}:8000/vote.html`;
                            peer.close();
                        }
                    }
                };
            } catch (err) {
                document.getElementById('localIP').innerHTML = 
                    '无法自动获取，请查看本机IP地址';
            }
        }
        getLocalIP();
    </script>
</body>
</html>